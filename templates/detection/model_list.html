<!-- templates/detection/model_list.html -->
{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'dataset_list' %}">–î–∞—Ç–∞—Å–µ—Ç—ã</a></li>
                <li class="breadcrumb-item"><a href="{% url 'dataset_detail' dataset.pk %}">{{ dataset.name }}</a></li>
                <li class="breadcrumb-item active">ML –ú–æ–¥–µ–ª–∏</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1>ML –ú–æ–¥–µ–ª–∏ - {{ dataset.name }}</h1>
                <p class="text-muted">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª—è–º–∏ –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è</p>
            </div>
            <button class="btn btn-success" data-toggle="modal" data-target="#createModelModal">
                <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å
            </button>
        </div>
    </div>
</div>

<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞—Ç–∞—Å–µ—Ç–µ -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center bg-light">
            <div class="card-body">
                <h3>{{ dataset.get_image_count }}</h3>
                <p class="text-muted mb-0">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center bg-light">
            <div class="card-body">
                <h3>{{ dataset.get_annotated_count }}</h3>
                <p class="text-muted mb-0">–†–∞–∑–º–µ—á–µ–Ω–æ</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center bg-light">
            <div class="card-body">
                <h3>{{ ml_models.count }}</h3>
                <p class="text-muted mb-0">–ú–æ–¥–µ–ª–µ–π</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center bg-light">
            <div class="card-body">
                <h3>{% widthratio dataset.get_annotated_count dataset.get_image_count 100 %}%</h3>
                <p class="text-muted mb-0">–ü—Ä–æ–≥—Ä–µ—Å—Å</p>
            </div>
        </div>
    </div>
</div>

{% if ml_models %}
<div class="row">
    {% for model in ml_models %}
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{{ model.name }}</h5>
                <span class="badge badge-{{ model.status_color }}">{{ model.get_status_display }}</span>
            </div>
            <div class="card-body">
                {% if model.description %}
                <p class="card-text">{{ model.description }}</p>
                {% endif %}

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ –æ–±—É—á–µ–Ω–∏—è -->
                {% if model.status == 'training' %}
                <div class="alert alert-info mb-3">
                    <i class="fas fa-sync-alt fa-spin"></i>
                    <strong>–ú–æ–¥–µ–ª—å –æ–±—É—á–∞–µ—Ç—Å—è...</strong> –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.
                    {% if model.training_log %}
                    <br><small>{{ model.training_log }}</small>
                    {% endif %}
                </div>
                {% elif model.status == 'trained' and model.training_log %}
                <div class="alert alert-success mb-3">
                    <i class="fas fa-check-circle"></i>
                    {{ model.training_log }}
                </div>
                {% elif model.status == 'error' and model.training_log %}
                <div class="alert alert-danger mb-3">
                    <i class="fas fa-exclamation-triangle"></i>
                    {{ model.training_log }}
                </div>
                {% endif %}

                <div class="model-stats mb-3">
                    <div class="row text-center">
                        {% if model.accuracy %}
                        <div class="col-4">
                            <h6 class="text-success">{{ model.accuracy|floatformat:1 }}%</h6>
                            <small class="text-muted">–¢–æ—á–Ω–æ—Å—Ç—å</small>
                        </div>
                        {% endif %}
                        <div class="col-4">
                            <h6>{{ model.created_at|date:"d.m.Y" }}</h6>
                            <small class="text-muted">–°–æ–∑–¥–∞–Ω–∞</small>
                        </div>
                        {% if model.trained_at %}
                        <div class="col-4">
                            <h6>{{ model.trained_at|date:"d.m.Y" }}</h6>
                            <small class="text-muted">–û–±—É—á–µ–Ω–∞</small>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="btn-group w-100">
                    {% if model.status == 'not_trained' and can_train %}
                    <form method="POST" action="{% url 'train_model' dataset.pk model.pk %}" class="d-inline" id="train-form-{{ model.id }}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-warning btn-sm" id="train-btn-{{ model.id }}">
                            <i class="fas fa-graduation-cap"></i> –û–±—É—á–∏—Ç—å
                        </button>
                    </form>
                    {% endif %}

                    <a href="{% url 'model_detail' dataset.pk model.pk %}" class="btn btn-info btn-sm">
                        <i class="fas fa-info-circle"></i> –î–µ—Ç–∞–ª–∏
                    </a>
                    <form method="POST" action="{% url 'delete_model' dataset.pk model.pk %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –º–æ–¥–µ–ª—å?')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center py-5">
    <i class="fas fa-robot fa-3x text-muted mb-3"></i>
    <h3 class="text-muted">–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π</h3>
    <p class="text-muted">–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é ML –º–æ–¥–µ–ª—å –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤</p>
    <button class="btn btn-success" data-toggle="modal" data-target="#createModelModal">
        –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –º–æ–¥–µ–ª—å
    </button>
</div>
{% endif %}

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –º–æ–¥–µ–ª–∏ -->
<div class="modal fade" id="createModelModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header btn-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-robot"></i> –°–æ–∑–¥–∞–Ω–∏–µ YOLO –º–æ–¥–µ–ª–∏
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form method="POST" action="{% url 'create_model' dataset.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–¥–µ–ª–∏ -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="modelName" class="font-weight-bold">
                                    <i class="fas fa-tag"></i> –ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ *
                                </label>
                                <input type="text" class="form-control" id="modelName" name="name" required
                                       placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="modelDescription" class="font-weight-bold">
                                    <i class="fas fa-align-left"></i> –û–ø–∏—Å–∞–Ω–∏–µ
                                </label>
                                <textarea class="form-control" id="modelDescription" name="description" rows="2"
                                          placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    {% if not can_train %}
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –î–ª—è –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º 3 —Ä–∞–∑–º–µ—á–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.
                        –°–µ–π—á–∞—Å —Ä–∞–∑–º–µ—á–µ–Ω–æ: <strong>{{ annotated_count }}</strong>
                    </div>
                    {% endif %}

                    <!-- –ü–∞–º—è—Ç–∫–∞ –ø–æ –æ–±—É—á–µ–Ω–∏—é -->
                    <div class="accordion mt-4" id="trainingGuideAccordion">
                        <div class="card">
                            <div class="card-header bg-light" id="guideHeading">
                                <h6 class="mb-0">
                                    <button class="btn btn-link btn-block text-left text-dark font-weight-bold" type="button"
                                            data-toggle="collapse" data-target="#guideCollapse" aria-expanded="true">
                                        <i class="fas fa-book-open"></i> üìö –ü–∞–º—è—Ç–∫–∞ –ø–æ –æ–±—É—á–µ–Ω–∏—é –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ —Ç–µ—Ä–º–∏–Ω–æ–≤
                                    </button>
                                </h6>
                            </div>
                            <div id="guideCollapse" class="collapse show" aria-labelledby="guideHeading" data-parent="#trainingGuideAccordion">
                                <div class="card-body">
                                    <div class="mb-4">
                                        <h6 class="text-primary mb-3">
                                            <i class="fas fa-book"></i> –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ —Ç–µ—Ä–º–∏–Ω–æ–≤:
                                        </h6>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <div class="border p-3 rounded">
                                                    <h6 class="text-success">üéØ –≠–ø–æ—Ö–∞ (Epoch)</h6>
                                                    <p class="small mb-0">–û–¥–∏–Ω –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ö–æ–¥ —á–µ—Ä–µ–∑ –≤—Å–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –ë–æ–ª—å—à–µ —ç–ø–æ—Ö = –±–æ–ª—å—à–µ –æ–±—É—á–µ–Ω–∏–µ, –Ω–æ —Ä–∏—Å–∫ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è.</p>
                                                </div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <div class="border p-3 rounded">
                                                    <h6 class="text-success">üì¶ –ë–∞—Ç—á (Batch)</h6>
                                                    <p class="small mb-0">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã—Ö –∑–∞ –æ–¥–∏–Ω —à–∞–≥. –ë–æ–ª—å—à–µ –±–∞—Ç—á = –±—ã—Å—Ç—Ä–µ–µ –æ–±—É—á–µ–Ω–∏–µ, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –±–æ–ª—å—à–µ –ø–∞–º—è—Ç–∏.</p>
                                                </div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <div class="border p-3 rounded">
                                                    <h6 class="text-success">üñºÔ∏è –†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h6>
                                                    <p class="small mb-0">–†–∞–∑–º–µ—Ä, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –º–∞—Å—à—Ç–∞–±–∏—Ä—É—é—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ë–æ–ª—å—à–µ —Ä–∞–∑–º–µ—Ä = –ª—É—á—à–µ –∫–∞—á–µ—Å—Ç–≤–æ –¥–µ—Ç–µ–∫—Ü–∏–∏, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ –æ–±—É—á–µ–Ω–∏–µ.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–±—ä–µ–º—É –¥–∞–Ω–Ω—ã—Ö -->
                                    <div class="mb-4">
                                        <h6 class="text-primary mb-3">
                                            <i class="fas fa-chart-line"></i> –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–±—ä–µ–º—É –¥–∞–Ω–Ω—ã—Ö:
                                        </h6>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="card {% if annotated_count < 100 %}border-warning{% else %}border-secondary{% endif %}">
                                                    <div class="card-body text-center p-3">
                                                        <h6 class="card-title">–ú–∞–ª—ã–π –¥–∞—Ç–∞—Å–µ—Ç<br><small>&lt; 100 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</small></h6>
                                                        <div class="text-warning">
                                                            <strong>–≠–ø–æ—Ö–∏: 50-80</strong><br>
                                                            <small>Batch: 4-8</small><br>
                                                            <small>Patience: 15-20</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card {% if 100 <= annotated_count < 500 %}border-info{% else %}border-secondary{% endif %}">
                                                    <div class="card-body text-center p-3">
                                                        <h6 class="card-title">–°—Ä–µ–¥–Ω–∏–π –¥–∞—Ç–∞—Å–µ—Ç<br><small>100-500 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</small></h6>
                                                        <div class="text-info">
                                                            <strong>–≠–ø–æ—Ö–∏: 100-120</strong><br>
                                                            <small>Batch: 8-16</small><br>
                                                            <small>Patience: 25-30</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card {% if annotated_count >= 500 %}border-success{% else %}border-secondary{% endif %}">
                                                    <div class="card-body text-center p-3">
                                                        <h6 class="card-title">–ë–æ–ª—å—à–æ–π –¥–∞—Ç–∞—Å–µ—Ç<br><small>> 500 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</small></h6>
                                                        <div class="text-success">
                                                            <strong>–≠–ø–æ—Ö–∏: 150+</strong><br>
                                                            <small>Batch: 16-32</small><br>
                                                            <small>Patience: 40-50</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- –í–∞–∂–Ω—ã–µ —Å–æ–≤–µ—Ç—ã -->
                                    <div class="alert alert-info">
                                        <h6 class="alert-heading">
                                            <i class="fas fa-lightbulb"></i> –í–∞–∂–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –¥–ª—è —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è:
                                        </h6>
                                        <ul class="small mb-0 pl-3">
                                            <li><strong>–ö–∞—á–µ—Å—Ç–≤–æ > –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</strong> - –ª—É—á—à–µ 100 –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ä–∞–∑–º–µ—Ç–æ–∫, —á–µ–º 1000 –ø–ª–æ—Ö–∏—Ö</li>
                                            <li><strong>–ë–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤</strong> - —Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å –∏–º–µ—Ç—å –ø—Ä–∏–º–µ—Ä–Ω–æ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–º–µ—Ä–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∞—Å—Å–∞</li>
                                            <li><strong>–†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –¥–∞–Ω–Ω—ã—Ö</strong> - –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</li>
                                            <li><strong>–í–∞–ª–∏–¥–∞—Ü–∏—è</strong> - –º–∏–Ω–∏–º—É–º 10-20% –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏</li>
                                            <li><strong>–ê—É–≥–º–µ–Ω—Ç–∞—Ü–∏—è</strong> - –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞—É–≥–º–µ–Ω—Ç–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" class="btn btn-success" {% if not can_train %}disabled{% endif %}>
                        <i class="fas fa-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
